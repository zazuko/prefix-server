---
# This runs the tests
platform: linux

image_resource:
  type: docker-image
  source:
    repository: node
    tag: '12'

inputs:
- name: repo

caches:
- path: /root/.npm
- path: /root/.cache

container_limits:
  memory: 1536mb

run:
  path: /bin/sh
  args:
  - -euxc
  - |
    apt-get update -y && apt-get install -y xvfb libgtk-3-dev libnotify-dev libgconf-2-4 libnss3 libxss1 libasound2
    cd repo
    npm ci
    export NODE_ENV=production
    npm run build-data
    npm run build:modern
    npm run start &
    sleep 20
    npm run e2e:test
